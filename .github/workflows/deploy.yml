name: Deploy to GitHub Pages

on:
  push:
    branches: [main, dev, fullpagevirtual]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # Main branch: build and deploy to this repo's GitHub Pages (slrgt.github.io/artsky/)
  build-main:
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build
        env:
          CI: true
          NODE_OPTIONS: '--max-old-space-size=4096'
          # OAuth redirect_uris: use repo owner + repo name so forks work without changes
          VITE_APP_ORIGIN: "https://${{ github.repository_owner }}.github.io"
          VITE_BASE_PATH: "/${{ github.event.repository.name }}/"

      - name: Verify build output
        run: |
          if [ ! -f dist/index.html ]; then
            echo "::error::Build failed: dist/index.html not found"
            exit 1
          fi

      - uses: actions/upload-pages-artifact@v3
        with:
          path: dist

  deploy-main:
    needs: build-main
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}
    steps:
      - id: deploy
        uses: actions/deploy-pages@v4

  # Dev branch: build with /artsky-dev/ base and push to slrgt/artsky-dev repo (slrgt.github.io/artsky-dev/)
  build-and-deploy-dev:
    if: github.ref == 'refs/heads/dev'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for dev site
        run: npm run build
        env:
          CI: true
          NODE_OPTIONS: '--max-old-space-size=4096'
          VITE_APP_ORIGIN: "https://${{ github.repository_owner }}.github.io"
          VITE_BASE_PATH: "/${{ github.event.repository.name }}-dev/"
          VITE_APP_ENV: 'dev'

      - name: Verify build output
        run: |
          if [ ! -f dist/index.html ]; then
            echo "::error::Build failed: dist/index.html not found"
            exit 1
          fi

      - name: Add README for artsky-dev repo
        run: cp artsky-dev-README.md dist/README.md

      - name: Deploy to dev repo
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.DEV_DEPLOY_TOKEN }}
          external_repository: ${{ github.repository_owner }}/${{ github.event.repository.name }}-dev
          publish_branch: main
          publish_dir: ./dist
          force_orphan: false
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com

  # Fullpage branch: build with / base and push to slrgt/artsky-fullpage repo (slrgt.github.io/artsky-fullpage/ or custom domain)
  build-and-deploy-fullpage:
    if: github.ref == 'refs/heads/fullpagevirtual'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for fullpage site
        run: npm run build
        env:
          CI: true
          NODE_OPTIONS: '--max-old-space-size=4096'
          VITE_APP_ORIGIN: "https://${{ github.repository_owner }}.github.io"
          VITE_BASE_PATH: "/${{ github.event.repository.name }}-fullpage/"
          VITE_APP_ENV: 'fullpage'

      - name: Verify build output
        run: |
          if [ ! -f dist/index.html ]; then
            echo "::error::Build failed: dist/index.html not found"
            exit 1
          fi

      - name: Deploy to fullpage repo
        uses: peaceiris/actions-gh-pages@v4
        with:
          personal_token: ${{ secrets.FULLPAGE_DEPLOY_TOKEN }}
          external_repository: ${{ github.repository_owner }}/${{ github.event.repository.name }}-fullpage
          publish_branch: main
          publish_dir: ./dist
          force_orphan: false
          user_name: github-actions[bot]
          user_email: github-actions[bot]@users.noreply.github.com
